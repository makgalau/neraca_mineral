(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.HeliaCore = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var HeliaCore=(()=>{var Jo=Object.create;var Ge=Object.defineProperty;var Qo=Object.getOwnPropertyDescriptor;var Xo=Object.getOwnPropertyNames;var Yo=Object.getPrototypeOf,Zo=Object.prototype.hasOwnProperty;var ei=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),N=(r,e)=>{for(var t in e)Ge(r,t,{get:e[t],enumerable:!0})},Nr=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Xo(e))!Zo.call(r,o)&&o!==t&&Ge(r,o,{get:()=>e[o],enumerable:!(n=Qo(e,o))||n.enumerable});return r};var ti=(r,e,t)=>(t=r!=null?Jo(Yo(r)):{},Nr(e||!r||!r.__esModule?Ge(t,"default",{value:r,enumerable:!0}):t,r)),ri=r=>Nr(Ge({},"__esModule",{value:!0}),r);var Po=ei((bl,yr)=>{"use strict";var Xs=Object.prototype.hasOwnProperty,B="~";function qe(){}Object.create&&(qe.prototype=Object.create(null),new qe().__proto__||(B=!1));function Ys(r,e,t){this.fn=r,this.context=e,this.once=t||!1}function Do(r,e,t,n,o){if(typeof t!="function")throw new TypeError("The listener must be a function");var i=new Ys(t,n||r,o),s=B?B+e:e;return r._events[s]?r._events[s].fn?r._events[s]=[r._events[s],i]:r._events[s].push(i):(r._events[s]=i,r._eventsCount++),r}function kt(r,e){--r._eventsCount===0?r._events=new qe:delete r._events[e]}function I(){this._events=new qe,this._eventsCount=0}I.prototype.eventNames=function(){var e=[],t,n;if(this._eventsCount===0)return e;for(n in t=this._events)Xs.call(t,n)&&e.push(B?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};I.prototype.listeners=function(e){var t=B?B+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var o=0,i=n.length,s=new Array(i);o<i;o++)s[o]=n[o].fn;return s};I.prototype.listenerCount=function(e){var t=B?B+e:e,n=this._events[t];return n?n.fn?1:n.length:0};I.prototype.emit=function(e,t,n,o,i,s){var c=B?B+e:e;if(!this._events[c])return!1;var u=this._events[c],p=arguments.length,h,m;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),p){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,n),!0;case 4:return u.fn.call(u.context,t,n,o),!0;case 5:return u.fn.call(u.context,t,n,o,i),!0;case 6:return u.fn.call(u.context,t,n,o,i,s),!0}for(m=1,h=new Array(p-1);m<p;m++)h[m-1]=arguments[m];u.fn.apply(u.context,h)}else{var k=u.length,H;for(m=0;m<k;m++)switch(u[m].once&&this.removeListener(e,u[m].fn,void 0,!0),p){case 1:u[m].fn.call(u[m].context);break;case 2:u[m].fn.call(u[m].context,t);break;case 3:u[m].fn.call(u[m].context,t,n);break;case 4:u[m].fn.call(u[m].context,t,n,o);break;default:if(!h)for(H=1,h=new Array(p-1);H<p;H++)h[H-1]=arguments[H];u[m].fn.apply(u[m].context,h)}}return!0};I.prototype.on=function(e,t,n){return Do(this,e,t,n,!1)};I.prototype.once=function(e,t,n){return Do(this,e,t,n,!0)};I.prototype.removeListener=function(e,t,n,o){var i=B?B+e:e;if(!this._events[i])return this;if(!t)return kt(this,i),this;var s=this._events[i];if(s.fn)s.fn===t&&(!o||s.once)&&(!n||s.context===n)&&kt(this,i);else{for(var c=0,u=[],p=s.length;c<p;c++)(s[c].fn!==t||o&&!s[c].once||n&&s[c].context!==n)&&u.push(s[c]);u.length?this._events[i]=u.length===1?u[0]:u:kt(this,i)}return this};I.prototype.removeAllListeners=function(e){var t;return e?(t=B?B+e:e,this._events[t]&&kt(this,t)):(this._events=new qe,this._eventsCount=0),this};I.prototype.off=I.prototype.removeListener;I.prototype.addListener=I.prototype.on;I.prefixed=B;I.EventEmitter=I;typeof yr<"u"&&(yr.exports=I)});var la={};N(la,{Helia:()=>Cr,isLibp2p:()=>fa});var ha=Symbol.for("@libp2p/connection");var ma=Symbol.for("@libp2p/content-routing");var wa=Symbol.for("@libp2p/peer-discovery");var ba=Symbol.for("@libp2p/peer-id");var ka=Symbol.for("@libp2p/peer-routing");var Ur;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(Ur||(Ur={}));var _a=Symbol.for("@libp2p/transport");var Dr;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(Dr||(Dr={}));var Z=class r extends Error{code;type;constructor(e="The operation was aborted"){super(e),this.code=r.code,this.type=r.type}static code="ABORT_ERR";static type="aborted"},ie=class extends Error{code;props;constructor(e,t,n){super(e),this.code=t,this.name=n?.name??"CodeError",this.props=n??{}}};var Ke=class extends EventTarget{#e=new Map;listenerCount(e){let t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let o=this.#e.get(e);o==null&&(o=[],this.#e.set(e,o)),o.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let o=this.#e.get(e);o!=null&&(o=o.filter(({callback:i})=>i!==t),this.#e.set(e,o))}dispatchEvent(e){let t=super.dispatchEvent(e),n=this.#e.get(e.type);return n==null||(n=n.filter(({once:o})=>!o),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new ni(e,t))}},_t=class extends Event{detail;constructor(e,t){super(e,t),this.detail=t?.detail}},ni=globalThis.CustomEvent??_t;var Pr=(r,...e)=>{try{[...e]}catch{}};function Rr(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function fe(...r){let e=[];for(let t of r)Rr(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function le(...r){let e=[];for(let t of r)Rr(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}function oi(r){return r[Symbol.asyncIterator]!=null}function ii(r){if(oi(r))return(async()=>{for await(let e of r);})();for(let e of r);}var $r=ii;var x=class extends Event{constructor(e,t){super(e),this.detail=t}};function de(){let r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}var Je=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},he=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new Je(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new Je(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var St=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function Or(r={}){return si(t=>{let n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function si(r,e){e=e??{};let t=e.onEnd,n=new he,o,i,s,c=de(),u=async()=>{try{return n.isEmpty()?s?{done:!0}:await new Promise((y,v)=>{i=L=>{i=null,n.push(L);try{y(r(n))}catch(T){v(T)}return o}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{c.resolve(),c=de()})}},p=y=>i!=null?i(y):(n.push(y),o),h=y=>(n=new he,i!=null?i({error:y}):(n.push({error:y}),o)),m=y=>{if(s)return o;if(e?.objectMode!==!0&&y?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return p({done:!1,value:y})},k=y=>s?o:(s=!0,y!=null?h(y):p({done:!0})),H=()=>(n=new he,k(),{done:!0}),w=y=>(k(y),{done:!0});if(o={[Symbol.asyncIterator](){return this},next:u,return:H,throw:w,push:m,end:k,get readableLength(){return n.size},onEmpty:async y=>{let v=y?.signal;if(v?.throwIfAborted(),n.isEmpty())return;let L,T;v!=null&&(L=new Promise((C,$)=>{T=()=>{$(new St)},v.addEventListener("abort",T)}));try{await Promise.race([c.promise,L])}finally{T!=null&&v!=null&&v?.removeEventListener("abort",T)}}},t==null)return o;let E=o;return o={[Symbol.asyncIterator](){return this},next(){return E.next()},throw(y){return E.throw(y),t!=null&&(t(y),t=void 0),{done:!0}},return(){return E.return(),t!=null&&(t(),t=void 0),{done:!0}},push:m,end(y){return E.end(y),t!=null&&(t(y),t=void 0),o},get readableLength(){return E.readableLength},onEmpty:y=>E.onEmpty(y)},o}var It=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.name="AbortError",this.code=t??"ABORT_ERR"}};async function Qe(r,e,t,n){let o=new It(n?.errorMessage,n?.errorCode);return t?.aborted===!0?Promise.reject(o):new Promise((i,s)=>{let c=p=>{n?.filter?.(p)!==!1&&(r.removeEventListener(e,c),t?.removeEventListener("abort",u),i(p))},u=()=>{r.removeEventListener(e,c),t?.removeEventListener("abort",u),s(o)};r.addEventListener(e,c),t?.addEventListener("abort",u)})}var Xe=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.name="AbortError",this.code=t??"ABORT_ERR"}};async function Mr(r,e,t){if(e==null)return r;if(e.aborted)return Promise.reject(new Xe(t?.errorMessage,t?.errorCode));let n,o=new Xe(t?.errorMessage,t?.errorCode);try{return await Promise.race([r,new Promise((i,s)=>{n=()=>{s(o)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}var Ye=class{deferred;signal;where;constructor(e,t){this.signal=t,this.deferred=de(),this.where=e,this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(new Z)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function ai(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var Ze=class{id;fn;options;priority;recipients;status;timeline;controller;constructor(e,t,n=0){this.id=ai(),this.status="queued",this.fn=e,this.priority=n,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,Pr(1/0,this.controller.signal),this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&this.controller.abort(new Z)}async join(e={}){let t=new Ye(new Error("where").stack,e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await Mr(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.signal?.removeEventListener("abort",this.onAbort)})}};function ci(r,e,t){let n=0,o=r.length;for(;o>0;){let i=Math.trunc(o/2),s=n+i;t(r[s],e)<=0?(n=++s,o-=i+1):o=i}return n}var Se=class extends Ke{concurrency;queue;pending;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.queue=[]}tryToStartAnother(){if(this.size===0)return queueMicrotask(()=>{this.safeDispatchEvent("empty")}),this.running===0&&queueMicrotask(()=>{this.safeDispatchEvent("idle")}),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){if(this.queue[this.size-1]?.priority>=e.priority){this.queue.push(e);return}let t=ci(this.queue,e,(n,o)=>o.priority-n.priority);this.queue.splice(t,0,e)}async add(e,t){t?.signal?.throwIfAborted();let n=new Ze(e,t,t?.priority),o=n.join(t).then(i=>(this.safeDispatchEvent("completed",{detail:i}),i)).catch(i=>{throw this.safeDispatchEvent("error",{detail:i}),i});return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),o}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Z)}),this.clear()}async onEmpty(e){this.size!==0&&await Qe(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Qe(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Qe(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=Or({objectMode:!0}),n=u=>{u!=null?this.abort():this.clear(),t.end(u)},o=u=>{u.detail!=null&&t.push(u.detail)},i=u=>{n(u.detail)},s=()=>{n()},c=()=>{n(new ie("Queue aborted","ERR_QUEUE_ABORTED"))};this.addEventListener("completed",o),this.addEventListener("error",i),this.addEventListener("idle",s),e?.signal?.addEventListener("abort",c);try{yield*t}finally{this.removeEventListener("completed",o),this.removeEventListener("error",i),this.removeEventListener("idle",s),e?.signal?.removeEventListener("abort",c),n()}}};var ui=["string","number","bigint","symbol"],fi=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function zr(r){if(r===null)return"null";if(r===void 0)return"undefined";if(r===!0||r===!1)return"boolean";let e=typeof r;if(ui.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(r))return"Array";if(li(r))return"Buffer";let t=di(r);return t||"Object"}function li(r){return r&&r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer.call(null,r)}function di(r){let e=Object.prototype.toString.call(r).slice(8,-1);if(fi.includes(e))return e}var a=class{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}};a.uint=new a(0,"uint",!0);a.negint=new a(1,"negint",!0);a.bytes=new a(2,"bytes",!0);a.string=new a(3,"string",!0);a.array=new a(4,"array",!1);a.map=new a(5,"map",!1);a.tag=new a(6,"tag",!1);a.float=new a(7,"float",!0);a.false=new a(7,"false",!0);a.true=new a(7,"true",!0);a.null=new a(7,"null",!0);a.undefined=new a(7,"undefined",!0);a.break=new a(7,"break",!0);var f=class{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}};var pe=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",hi=new TextDecoder,pi=new TextEncoder;function et(r){return pe&&globalThis.Buffer.isBuffer(r)}function Ie(r){return r instanceof Uint8Array?et(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r:Uint8Array.from(r)}var jr=pe?(r,e,t)=>t-e>64?globalThis.Buffer.from(r.subarray(e,t)).toString("utf8"):qr(r,e,t):(r,e,t)=>t-e>64?hi.decode(r.subarray(e,t)):qr(r,e,t),tt=pe?r=>r.length>64?globalThis.Buffer.from(r):Fr(r):r=>r.length>64?pi.encode(r):Fr(r),V=r=>Uint8Array.from(r),me=pe?(r,e,t)=>et(r)?new Uint8Array(r.subarray(e,t)):r.slice(e,t):(r,e,t)=>r.slice(e,t),Wr=pe?(r,e)=>(r=r.map(t=>t instanceof Uint8Array?t:globalThis.Buffer.from(t)),Ie(globalThis.Buffer.concat(r,e))):(r,e)=>{let t=new Uint8Array(e),n=0;for(let o of r)n+o.length>t.length&&(o=o.subarray(0,t.length-n)),t.set(o,n),n+=o.length;return t},Hr=pe?r=>globalThis.Buffer.allocUnsafe(r):r=>new Uint8Array(r);function Gr(r,e){if(et(r)&&et(e))return r.compare(e);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function Fr(r){let e=[],t=0;for(let n=0;n<r.length;n++){let o=r.charCodeAt(n);o<128?e[t++]=o:o<2048?(e[t++]=o>>6|192,e[t++]=o&63|128):(o&64512)===55296&&n+1<r.length&&(r.charCodeAt(n+1)&64512)===56320?(o=65536+((o&1023)<<10)+(r.charCodeAt(++n)&1023),e[t++]=o>>18|240,e[t++]=o>>12&63|128,e[t++]=o>>6&63|128,e[t++]=o&63|128):(e[t++]=o>>12|224,e[t++]=o>>6&63|128,e[t++]=o&63|128)}return e}function qr(r,e,t){let n=[];for(;e<t;){let o=r[e],i=null,s=o>239?4:o>223?3:o>191?2:1;if(e+s<=t){let c,u,p,h;switch(s){case 1:o<128&&(i=o);break;case 2:c=r[e+1],(c&192)===128&&(h=(o&31)<<6|c&63,h>127&&(i=h));break;case 3:c=r[e+1],u=r[e+2],(c&192)===128&&(u&192)===128&&(h=(o&15)<<12|(c&63)<<6|u&63,h>2047&&(h<55296||h>57343)&&(i=h));break;case 4:c=r[e+1],u=r[e+2],p=r[e+3],(c&192)===128&&(u&192)===128&&(p&192)===128&&(h=(o&15)<<18|(c&63)<<12|(u&63)<<6|p&63,h>65535&&h<1114112&&(i=h))}}i===null?(i=65533,s=1):i>65535&&(i-=65536,n.push(i>>>10&1023|55296),i=56320|i&1023),n.push(i),e+=s}return Lt(n)}var Vr=4096;function Lt(r){let e=r.length;if(e<=Vr)return String.fromCharCode.apply(String,r);let t="",n=0;for(;n<e;)t+=String.fromCharCode.apply(String,r.slice(n,n+=Vr));return t}var mi=256,Le=class{constructor(e=mi){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){let o=t.length-(this.maxCursor-this.cursor)-1;t.set(e,o)}else{if(t){let o=t.length-(this.maxCursor-this.cursor)-1;o<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,o),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=Hr(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){let n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=me(n,0,this.cursor)}else t=Wr(this.chunks,this.cursor);return e&&this.reset(),t}};var d="CBOR decode error:",ye="CBOR encode error:",Be=[];Be[23]=1;Be[24]=2;Be[25]=3;Be[26]=5;Be[27]=9;function K(r,e,t){if(r.length-e<t)throw new Error(`${d} not enough data for type`)}var A=[24,256,65536,4294967296,BigInt("18446744073709551616")];function U(r,e,t){K(r,e,1);let n=r[e];if(t.strict===!0&&n<A[0])throw new Error(`${d} integer encoded in more bytes than necessary (strict decode)`);return n}function D(r,e,t){K(r,e,2);let n=r[e]<<8|r[e+1];if(t.strict===!0&&n<A[1])throw new Error(`${d} integer encoded in more bytes than necessary (strict decode)`);return n}function P(r,e,t){K(r,e,4);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3];if(t.strict===!0&&n<A[2])throw new Error(`${d} integer encoded in more bytes than necessary (strict decode)`);return n}function R(r,e,t){K(r,e,8);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3],o=r[e+4]*16777216+(r[e+5]<<16)+(r[e+6]<<8)+r[e+7],i=(BigInt(n)<<BigInt(32))+BigInt(o);if(t.strict===!0&&i<A[3])throw new Error(`${d} integer encoded in more bytes than necessary (strict decode)`);if(i<=Number.MAX_SAFE_INTEGER)return Number(i);if(t.allowBigInt===!0)return i;throw new Error(`${d} integers outside of the safe integer range are not supported`)}function Kr(r,e,t,n){return new f(a.uint,U(r,e+1,n),2)}function Jr(r,e,t,n){return new f(a.uint,D(r,e+1,n),3)}function Qr(r,e,t,n){return new f(a.uint,P(r,e+1,n),5)}function Xr(r,e,t,n){return new f(a.uint,R(r,e+1,n),9)}function O(r,e){return _(r,0,e.value)}function _(r,e,t){if(t<A[0]){let n=Number(t);r.push([e|n])}else if(t<A[1]){let n=Number(t);r.push([e|24,n])}else if(t<A[2]){let n=Number(t);r.push([e|25,n>>>8,n&255])}else if(t<A[3]){let n=Number(t);r.push([e|26,n>>>24&255,n>>>16&255,n>>>8&255,n&255])}else{let n=BigInt(t);if(n<A[4]){let o=[e|27,0,0,0,0,0,0,0],i=Number(n&BigInt(4294967295)),s=Number(n>>BigInt(32)&BigInt(4294967295));o[8]=i&255,i=i>>8,o[7]=i&255,i=i>>8,o[6]=i&255,i=i>>8,o[5]=i&255,o[4]=s&255,s=s>>8,o[3]=s&255,s=s>>8,o[2]=s&255,s=s>>8,o[1]=s&255,r.push(o)}else throw new Error(`${d} encountered BigInt larger than allowable range`)}}O.encodedSize=function(e){return _.encodedSize(e.value)};_.encodedSize=function(e){return e<A[0]?1:e<A[1]?2:e<A[2]?3:e<A[3]?5:9};O.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function Yr(r,e,t,n){return new f(a.negint,-1-U(r,e+1,n),2)}function Zr(r,e,t,n){return new f(a.negint,-1-D(r,e+1,n),3)}function en(r,e,t,n){return new f(a.negint,-1-P(r,e+1,n),5)}var Bt=BigInt(-1),tn=BigInt(1);function rn(r,e,t,n){let o=R(r,e+1,n);if(typeof o!="bigint"){let i=-1-o;if(i>=Number.MIN_SAFE_INTEGER)return new f(a.negint,i,9)}if(n.allowBigInt!==!0)throw new Error(`${d} integers outside of the safe integer range are not supported`);return new f(a.negint,Bt-BigInt(o),9)}function rt(r,e){let t=e.value,n=typeof t=="bigint"?t*Bt-tn:t*-1-1;_(r,e.type.majorEncoded,n)}rt.encodedSize=function(e){let t=e.value,n=typeof t=="bigint"?t*Bt-tn:t*-1-1;return n<A[0]?1:n<A[1]?2:n<A[2]?3:n<A[3]?5:9};rt.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function Ce(r,e,t,n){K(r,e,t+n);let o=me(r,e+t,e+t+n);return new f(a.bytes,o,t+n)}function nn(r,e,t,n){return Ce(r,e,1,t)}function on(r,e,t,n){return Ce(r,e,2,U(r,e+1,n))}function sn(r,e,t,n){return Ce(r,e,3,D(r,e+1,n))}function an(r,e,t,n){return Ce(r,e,5,P(r,e+1,n))}function cn(r,e,t,n){let o=R(r,e+1,n);if(typeof o=="bigint")throw new Error(`${d} 64-bit integer bytes lengths not supported`);return Ce(r,e,9,o)}function nt(r){return r.encodedBytes===void 0&&(r.encodedBytes=r.type===a.string?tt(r.value):r.value),r.encodedBytes}function ge(r,e){let t=nt(e);_(r,e.type.majorEncoded,t.length),r.push(t)}ge.encodedSize=function(e){let t=nt(e);return _.encodedSize(t.length)+t.length};ge.compareTokens=function(e,t){return gi(nt(e),nt(t))};function gi(r,e){return r.length<e.length?-1:r.length>e.length?1:Gr(r,e)}function Ne(r,e,t,n,o){let i=t+n;K(r,e,i);let s=new f(a.string,jr(r,e+t,e+i),i);return o.retainStringBytes===!0&&(s.byteValue=me(r,e+t,e+i)),s}function un(r,e,t,n){return Ne(r,e,1,t,n)}function fn(r,e,t,n){return Ne(r,e,2,U(r,e+1,n),n)}function ln(r,e,t,n){return Ne(r,e,3,D(r,e+1,n),n)}function dn(r,e,t,n){return Ne(r,e,5,P(r,e+1,n),n)}function hn(r,e,t,n){let o=R(r,e+1,n);if(typeof o=="bigint")throw new Error(`${d} 64-bit integer string lengths not supported`);return Ne(r,e,9,o,n)}var pn=ge;function we(r,e,t,n){return new f(a.array,n,t)}function mn(r,e,t,n){return we(r,e,1,t)}function yn(r,e,t,n){return we(r,e,2,U(r,e+1,n))}function gn(r,e,t,n){return we(r,e,3,D(r,e+1,n))}function wn(r,e,t,n){return we(r,e,5,P(r,e+1,n))}function xn(r,e,t,n){let o=R(r,e+1,n);if(typeof o=="bigint")throw new Error(`${d} 64-bit integer array lengths not supported`);return we(r,e,9,o)}function bn(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${d} indefinite length items not allowed`);return we(r,e,1,1/0)}function ot(r,e){_(r,a.array.majorEncoded,e.value)}ot.compareTokens=O.compareTokens;ot.encodedSize=function(e){return _.encodedSize(e.value)};function xe(r,e,t,n){return new f(a.map,n,t)}function En(r,e,t,n){return xe(r,e,1,t)}function kn(r,e,t,n){return xe(r,e,2,U(r,e+1,n))}function vn(r,e,t,n){return xe(r,e,3,D(r,e+1,n))}function An(r,e,t,n){return xe(r,e,5,P(r,e+1,n))}function Tn(r,e,t,n){let o=R(r,e+1,n);if(typeof o=="bigint")throw new Error(`${d} 64-bit integer map lengths not supported`);return xe(r,e,9,o)}function _n(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${d} indefinite length items not allowed`);return xe(r,e,1,1/0)}function it(r,e){_(r,a.map.majorEncoded,e.value)}it.compareTokens=O.compareTokens;it.encodedSize=function(e){return _.encodedSize(e.value)};function Sn(r,e,t,n){return new f(a.tag,t,1)}function In(r,e,t,n){return new f(a.tag,U(r,e+1,n),2)}function Ln(r,e,t,n){return new f(a.tag,D(r,e+1,n),3)}function Bn(r,e,t,n){return new f(a.tag,P(r,e+1,n),5)}function Cn(r,e,t,n){return new f(a.tag,R(r,e+1,n),9)}function st(r,e){_(r,a.tag.majorEncoded,e.value)}st.compareTokens=O.compareTokens;st.encodedSize=function(e){return _.encodedSize(e.value)};var vi=20,Ai=21,Ti=22,_i=23;function Nn(r,e,t,n){if(n.allowUndefined===!1)throw new Error(`${d} undefined values are not supported`);return n.coerceUndefinedToNull===!0?new f(a.null,null,1):new f(a.undefined,void 0,1)}function Un(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${d} indefinite length items not allowed`);return new f(a.break,void 0,1)}function Ct(r,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(r))throw new Error(`${d} NaN values are not supported`);if(t.allowInfinity===!1&&(r===1/0||r===-1/0))throw new Error(`${d} Infinity values are not supported`)}return new f(a.float,r,e)}function Dn(r,e,t,n){return Ct(Nt(r,e+1),3,n)}function Pn(r,e,t,n){return Ct(Ut(r,e+1),5,n)}function Rn(r,e,t,n){return Ct(zn(r,e+1),9,n)}function at(r,e,t){let n=e.value;if(n===!1)r.push([a.float.majorEncoded|vi]);else if(n===!0)r.push([a.float.majorEncoded|Ai]);else if(n===null)r.push([a.float.majorEncoded|Ti]);else if(n===void 0)r.push([a.float.majorEncoded|_i]);else{let o,i=!1;(!t||t.float64!==!0)&&(On(n),o=Nt(F,1),n===o||Number.isNaN(n)?(F[0]=249,r.push(F.slice(0,3)),i=!0):(Mn(n),o=Ut(F,1),n===o&&(F[0]=250,r.push(F.slice(0,5)),i=!0))),i||(Si(n),o=zn(F,1),F[0]=251,r.push(F.slice(0,9)))}}at.encodedSize=function(e,t){let n=e.value;if(n===!1||n===!0||n===null||n===void 0)return 1;if(!t||t.float64!==!0){On(n);let o=Nt(F,1);if(n===o||Number.isNaN(n))return 3;if(Mn(n),o=Ut(F,1),n===o)return 5}return 9};var $n=new ArrayBuffer(9),M=new DataView($n,1),F=new Uint8Array($n,0);function On(r){if(r===1/0)M.setUint16(0,31744,!1);else if(r===-1/0)M.setUint16(0,64512,!1);else if(Number.isNaN(r))M.setUint16(0,32256,!1);else{M.setFloat32(0,r);let e=M.getUint32(0),t=(e&2139095040)>>23,n=e&8388607;if(t===255)M.setUint16(0,31744,!1);else if(t===0)M.setUint16(0,(r&2147483648)>>16|n>>13,!1);else{let o=t-127;o<-24?M.setUint16(0,0):o<-14?M.setUint16(0,(e&2147483648)>>16|1<<24+o,!1):M.setUint16(0,(e&2147483648)>>16|o+15<<10|n>>13,!1)}}}function Nt(r,e){if(r.length-e<2)throw new Error(`${d} not enough data for float16`);let t=(r[e]<<8)+r[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;let n=t>>10&31,o=t&1023,i;return n===0?i=o*2**-24:n!==31?i=(o+1024)*2**(n-25):i=o===0?1/0:NaN,t&32768?-i:i}function Mn(r){M.setFloat32(0,r,!1)}function Ut(r,e){if(r.length-e<4)throw new Error(`${d} not enough data for float32`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,4).getFloat32(0,!1)}function Si(r){M.setFloat64(0,r,!1)}function zn(r,e){if(r.length-e<8)throw new Error(`${d} not enough data for float64`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,8).getFloat64(0,!1)}at.compareTokens=O.compareTokens;function g(r,e,t){throw new Error(`${d} encountered invalid minor (${t}) for major ${r[e]>>>5}`)}function ct(r){return()=>{throw new Error(`${d} ${r}`)}}var l=[];for(let r=0;r<=23;r++)l[r]=g;l[24]=Kr;l[25]=Jr;l[26]=Qr;l[27]=Xr;l[28]=g;l[29]=g;l[30]=g;l[31]=g;for(let r=32;r<=55;r++)l[r]=g;l[56]=Yr;l[57]=Zr;l[58]=en;l[59]=rn;l[60]=g;l[61]=g;l[62]=g;l[63]=g;for(let r=64;r<=87;r++)l[r]=nn;l[88]=on;l[89]=sn;l[90]=an;l[91]=cn;l[92]=g;l[93]=g;l[94]=g;l[95]=ct("indefinite length bytes/strings are not supported");for(let r=96;r<=119;r++)l[r]=un;l[120]=fn;l[121]=ln;l[122]=dn;l[123]=hn;l[124]=g;l[125]=g;l[126]=g;l[127]=ct("indefinite length bytes/strings are not supported");for(let r=128;r<=151;r++)l[r]=mn;l[152]=yn;l[153]=gn;l[154]=wn;l[155]=xn;l[156]=g;l[157]=g;l[158]=g;l[159]=bn;for(let r=160;r<=183;r++)l[r]=En;l[184]=kn;l[185]=vn;l[186]=An;l[187]=Tn;l[188]=g;l[189]=g;l[190]=g;l[191]=_n;for(let r=192;r<=215;r++)l[r]=Sn;l[216]=In;l[217]=Ln;l[218]=Bn;l[219]=Cn;l[220]=g;l[221]=g;l[222]=g;l[223]=g;for(let r=224;r<=243;r++)l[r]=ct("simple values are not supported");l[244]=g;l[245]=g;l[246]=g;l[247]=Nn;l[248]=ct("simple values are not supported");l[249]=Dn;l[250]=Pn;l[251]=Rn;l[252]=g;l[253]=g;l[254]=g;l[255]=Un;var q=[];for(let r=0;r<24;r++)q[r]=new f(a.uint,r,1);for(let r=-1;r>=-24;r--)q[31-r]=new f(a.negint,r,1);q[64]=new f(a.bytes,new Uint8Array(0),1);q[96]=new f(a.string,"",1);q[128]=new f(a.array,0,1);q[160]=new f(a.map,0,1);q[244]=new f(a.false,!1,1);q[245]=new f(a.true,!0,1);q[246]=new f(a.null,null,1);function Fn(r){switch(r.type){case a.false:return V([244]);case a.true:return V([245]);case a.null:return V([246]);case a.bytes:return r.value.length?void 0:V([64]);case a.string:return r.value===""?V([96]):void 0;case a.array:return r.value===0?V([128]):void 0;case a.map:return r.value===0?V([160]):void 0;case a.uint:return r.value<24?V([Number(r.value)]):void 0;case a.negint:if(r.value>=-24)return V([31-Number(r.value)])}}var Li={float64:!1,mapSorter:Ni,quickEncodeToken:Fn};function Bi(){let r=[];return r[a.uint.major]=O,r[a.negint.major]=rt,r[a.bytes.major]=ge,r[a.string.major]=pn,r[a.array.major]=ot,r[a.map.major]=it,r[a.tag.major]=st,r[a.float.major]=at,r}var qn=Bi(),Dt=new Le,ft=class r{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${ye} object contains circular references`);return new r(t,e)}},ee={null:new f(a.null,null),undefined:new f(a.undefined,void 0),true:new f(a.true,!0),false:new f(a.false,!1),emptyArray:new f(a.array,0),emptyMap:new f(a.map,0)},te={number(r,e,t,n){return!Number.isInteger(r)||!Number.isSafeInteger(r)?new f(a.float,r):r>=0?new f(a.uint,r):new f(a.negint,r)},bigint(r,e,t,n){return r>=BigInt(0)?new f(a.uint,r):new f(a.negint,r)},Uint8Array(r,e,t,n){return new f(a.bytes,r)},string(r,e,t,n){return new f(a.string,r)},boolean(r,e,t,n){return r?ee.true:ee.false},null(r,e,t,n){return ee.null},undefined(r,e,t,n){return ee.undefined},ArrayBuffer(r,e,t,n){return new f(a.bytes,new Uint8Array(r))},DataView(r,e,t,n){return new f(a.bytes,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))},Array(r,e,t,n){if(!r.length)return t.addBreakTokens===!0?[ee.emptyArray,new f(a.break)]:ee.emptyArray;n=ft.createCheck(n,r);let o=[],i=0;for(let s of r)o[i++]=ut(s,t,n);return t.addBreakTokens?[new f(a.array,r.length),o,new f(a.break)]:[new f(a.array,r.length),o]},Object(r,e,t,n){let o=e!=="Object",i=o?r.keys():Object.keys(r),s=o?r.size:i.length;if(!s)return t.addBreakTokens===!0?[ee.emptyMap,new f(a.break)]:ee.emptyMap;n=ft.createCheck(n,r);let c=[],u=0;for(let p of i)c[u++]=[ut(p,t,n),ut(o?r.get(p):r[p],t,n)];return Ci(c,t),t.addBreakTokens?[new f(a.map,s),c,new f(a.break)]:[new f(a.map,s),c]}};te.Map=te.Object;te.Buffer=te.Uint8Array;for(let r of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))te[`${r}Array`]=te.DataView;function ut(r,e={},t){let n=zr(r),o=e&&e.typeEncoders&&e.typeEncoders[n]||te[n];if(typeof o=="function"){let s=o(r,n,e,t);if(s!=null)return s}let i=te[n];if(!i)throw new Error(`${ye} unsupported type: ${n}`);return i(r,n,e,t)}function Ci(r,e){e.mapSorter&&r.sort(e.mapSorter)}function Ni(r,e){let t=Array.isArray(r[0])?r[0][0]:r[0],n=Array.isArray(e[0])?e[0][0]:e[0];if(t.type!==n.type)return t.type.compare(n.type);let o=t.type.major,i=qn[o].compareTokens(t,n);return i===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),i}function Vn(r,e,t,n){if(Array.isArray(e))for(let o of e)Vn(r,o,t,n);else t[e.type.major](r,e,n)}function jn(r,e,t){let n=ut(r,t);if(!Array.isArray(n)&&t.quickEncodeToken){let o=t.quickEncodeToken(n);if(o)return o;let i=e[n.type.major];if(i.encodedSize){let s=i.encodedSize(n,t),c=new Le(s);if(i(c,n,t),c.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return Ie(c.chunks[0])}}return Dt.reset(),Vn(Dt,n,e,t),Dt.toBytes(!0)}function Ue(r,e){return e=Object.assign({},Li,e),jn(r,qn,e)}var Ui={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0},Pt=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){let e=this.data[this._pos],t=q[e];if(t===void 0){let n=l[e];if(!n)throw new Error(`${d} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);let o=e&31;t=n(this.data,this._pos,o,this.options)}return this._pos+=t.encodedLength,t}},De=Symbol.for("DONE"),lt=Symbol.for("BREAK");function Di(r,e,t){let n=[];for(let o=0;o<r.value;o++){let i=Pe(e,t);if(i===lt){if(r.value===1/0)break;throw new Error(`${d} got unexpected break to lengthed array`)}if(i===De)throw new Error(`${d} found array but not enough entries (got ${o}, expected ${r.value})`);n[o]=i}return n}function Pi(r,e,t){let n=t.useMaps===!0,o=n?void 0:{},i=n?new Map:void 0;for(let s=0;s<r.value;s++){let c=Pe(e,t);if(c===lt){if(r.value===1/0)break;throw new Error(`${d} got unexpected break to lengthed map`)}if(c===De)throw new Error(`${d} found map but not enough entries (got ${s} [no key], expected ${r.value})`);if(n!==!0&&typeof c!="string")throw new Error(`${d} non-string keys not supported (got ${typeof c})`);if(t.rejectDuplicateMapKeys===!0&&(n&&i.has(c)||!n&&c in o))throw new Error(`${d} found repeat map key "${c}"`);let u=Pe(e,t);if(u===De)throw new Error(`${d} found map but not enough entries (got ${s} [no value], expected ${r.value})`);n?i.set(c,u):o[c]=u}return n?i:o}function Pe(r,e){if(r.done())return De;let t=r.next();if(t.type===a.break)return lt;if(t.type.terminal)return t.value;if(t.type===a.array)return Di(t,r,e);if(t.type===a.map)return Pi(t,r,e);if(t.type===a.tag){if(e.tags&&typeof e.tags[t.value]=="function"){let n=Pe(r,e);return e.tags[t.value](n)}throw new Error(`${d} tag not supported (${t.value})`)}throw new Error("unsupported")}function Rt(r,e){if(!(r instanceof Uint8Array))throw new Error(`${d} data to decode must be a Uint8Array`);e=Object.assign({},Ui,e);let t=e.tokenizer||new Pt(r,e),n=Pe(t,e);if(n===De)throw new Error(`${d} did not find any content to decode`);if(n===lt)throw new Error(`${d} got unexpected break`);return[n,r.subarray(t.pos())]}function j(r,e){let[t,n]=Rt(r,e);if(n.length>0)throw new Error(`${d} too many terminals, data makes no sense`);return t}function dt(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}var qt={};N(qt,{base10:()=>Fi});var vu=new Uint8Array(0);function Wn(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function J(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Hn(r){return new TextEncoder().encode(r)}function Gn(r){return new TextDecoder().decode(r)}function Ri(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var o=0;o<r.length;o++){var i=r.charAt(o),s=i.charCodeAt(0);if(t[s]!==255)throw new TypeError(i+" is ambiguous");t[s]=o}var c=r.length,u=r.charAt(0),p=Math.log(c)/Math.log(256),h=Math.log(256)/Math.log(c);function m(w){if(w instanceof Uint8Array||(ArrayBuffer.isView(w)?w=new Uint8Array(w.buffer,w.byteOffset,w.byteLength):Array.isArray(w)&&(w=Uint8Array.from(w))),!(w instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(w.length===0)return"";for(var E=0,y=0,v=0,L=w.length;v!==L&&w[v]===0;)v++,E++;for(var T=(L-v)*h+1>>>0,C=new Uint8Array(T);v!==L;){for(var $=w[v],Y=0,z=T-1;($!==0||Y<y)&&z!==-1;z--,Y++)$+=256*C[z]>>>0,C[z]=$%c>>>0,$=$/c>>>0;if($!==0)throw new Error("Non-zero carry");y=Y,v++}for(var G=T-y;G!==T&&C[G]===0;)G++;for(var He=u.repeat(E);G<T;++G)He+=r.charAt(C[G]);return He}function k(w){if(typeof w!="string")throw new TypeError("Expected String");if(w.length===0)return new Uint8Array;var E=0;if(w[E]!==" "){for(var y=0,v=0;w[E]===u;)y++,E++;for(var L=(w.length-E)*p+1>>>0,T=new Uint8Array(L);w[E];){var C=t[w.charCodeAt(E)];if(C===255)return;for(var $=0,Y=L-1;(C!==0||$<v)&&Y!==-1;Y--,$++)C+=c*T[Y]>>>0,T[Y]=C%256>>>0,C=C/256>>>0;if(C!==0)throw new Error("Non-zero carry");v=$,E++}if(w[E]!==" "){for(var z=L-v;z!==L&&T[z]===0;)z++;for(var G=new Uint8Array(y+(L-z)),He=y;z!==L;)G[He++]=T[z++];return G}}}function H(w){var E=k(w);if(E)return E;throw new Error(`Non-${e} character`)}return{encode:m,decodeUnsafe:k,decode:H}}var $i=Ri,Oi=$i,Jn=Oi;var Ot=class{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Mt=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Qn(this,e)}},zt=class{decoders;constructor(e){this.decoders=e}or(e){return Qn(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function Qn(r,e){return new zt({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}var Ft=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,o){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=o,this.encoder=new Ot(e,t,n),this.decoder=new Mt(e,t,o)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function be({name:r,prefix:e,encode:t,decode:n}){return new Ft(r,e,t,n)}function re({name:r,prefix:e,alphabet:t}){let{encode:n,decode:o}=Jn(t,r);return be({prefix:e,name:r,encode:n,decode:i=>J(o(i))})}function Mi(r,e,t,n){let o={};for(let h=0;h<e.length;++h)o[e[h]]=h;let i=r.length;for(;r[i-1]==="=";)--i;let s=new Uint8Array(i*t/8|0),c=0,u=0,p=0;for(let h=0;h<i;++h){let m=o[r[h]];if(m===void 0)throw new SyntaxError(`Non-${n} character`);u=u<<t|m,c+=t,c>=8&&(c-=8,s[p++]=255&u>>c)}if(c>=t||255&u<<8-c)throw new SyntaxError("Unexpected end of data");return s}function zi(r,e,t){let n=e[e.length-1]==="=",o=(1<<t)-1,i="",s=0,c=0;for(let u=0;u<r.length;++u)for(c=c<<8|r[u],s+=8;s>t;)s-=t,i+=e[o&c>>s];if(s!==0&&(i+=e[o&c<<t-s]),n)for(;i.length*t&7;)i+="=";return i}function b({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return be({prefix:e,name:r,encode(o){return zi(o,n,t)},decode(o){return Mi(o,n,t,r)}})}var Fi=re({prefix:"9",name:"base10",alphabet:"0123456789"});var Vt={};N(Vt,{base16:()=>qi,base16upper:()=>Vi});var qi=b({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Vi=b({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var jt={};N(jt,{base2:()=>ji});var ji=b({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Wt={};N(Wt,{base256emoji:()=>Ji});var Xn=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),Wi=Xn.reduce((r,e,t)=>(r[t]=e,r),[]),Hi=Xn.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function Gi(r){return r.reduce((e,t)=>(e+=Wi[t],e),"")}function Ki(r){let e=[];for(let t of r){let n=Hi[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}var Ji=be({prefix:"\u{1F680}",name:"base256emoji",encode:Gi,decode:Ki});var Ht={};N(Ht,{base32:()=>Ee,base32hex:()=>Zi,base32hexpad:()=>ts,base32hexpadupper:()=>rs,base32hexupper:()=>es,base32pad:()=>Xi,base32padupper:()=>Yi,base32upper:()=>Qi,base32z:()=>ns});var Ee=b({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Qi=b({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Xi=b({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Yi=b({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Zi=b({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),es=b({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),ts=b({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),rs=b({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),ns=b({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Gt={};N(Gt,{base36:()=>Re,base36upper:()=>os});var Re=re({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),os=re({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var Kt={};N(Kt,{base58btc:()=>W,base58flickr:()=>is});var W=re({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),is=re({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Jt={};N(Jt,{base64:()=>ht,base64pad:()=>ss,base64url:()=>as,base64urlpad:()=>cs});var ht=b({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),ss=b({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),as=b({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),cs=b({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var Qt={};N(Qt,{base8:()=>us});var us=b({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Xt={};N(Xt,{identity:()=>fs});var fs=be({prefix:"\0",name:"identity",encode:r=>Gn(r),decode:r=>Hn(r)});var Mu=new TextEncoder,zu=new TextDecoder;var Yn=512;var eo=85;var er={};N(er,{identity:()=>Zt});var ls=oo,ro=128,ds=127,hs=~ds,ps=Math.pow(2,31);function oo(r,e,t){e=e||[],t=t||0;for(var n=t;r>=ps;)e[t++]=r&255|ro,r/=128;for(;r&hs;)e[t++]=r&255|ro,r>>>=7;return e[t]=r|0,oo.bytes=t-n+1,e}var ms=Yt,ys=128,no=127;function Yt(r,n){var t=0,n=n||0,o=0,i=n,s,c=r.length;do{if(i>=c)throw Yt.bytes=0,new RangeError("Could not decode varint");s=r[i++],t+=o<28?(s&no)<<o:(s&no)*Math.pow(2,o),o+=7}while(s>=ys);return Yt.bytes=i-n,t}var gs=Math.pow(2,7),ws=Math.pow(2,14),xs=Math.pow(2,21),bs=Math.pow(2,28),Es=Math.pow(2,35),ks=Math.pow(2,42),vs=Math.pow(2,49),As=Math.pow(2,56),Ts=Math.pow(2,63),_s=function(r){return r<gs?1:r<ws?2:r<xs?3:r<bs?4:r<Es?5:r<ks?6:r<vs?7:r<As?8:r<Ts?9:10},Ss={encode:ls,decode:ms,encodingLength:_s},Is=Ss,$e=Is;function Oe(r,e=0){return[$e.decode(r,e),$e.decode.bytes]}function ke(r,e,t=0){return $e.encode(r,e,t),e}function ve(r){return $e.encodingLength(r)}function ae(r,e){let t=e.byteLength,n=ve(r),o=n+ve(t),i=new Uint8Array(o+t);return ke(r,i,0),ke(t,i,n),i.set(e,o),new Ae(r,t,e,i)}function io(r){let e=J(r),[t,n]=Oe(e),[o,i]=Oe(e.subarray(n)),s=e.subarray(n+i);if(s.byteLength!==o)throw new Error("Incorrect length");return new Ae(t,o,s,e)}function so(r,e){if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Wn(r.bytes,t.bytes)}}var Ae=class{code;size;digest;bytes;constructor(e,t,n,o){this.code=e,this.size=t,this.digest=n,this.bytes=o}};var ao=0,Ls="identity",co=J;function Bs(r){return ae(ao,co(r))}var Zt={code:ao,name:Ls,encode:co,digest:Bs};var ir={};N(ir,{sha256:()=>nr,sha512:()=>or});function rr({name:r,code:e,encode:t}){return new tr(r,e,t)}var tr=class{name;code;encode;constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?ae(this.code,t):t.then(n=>ae(this.code,n))}else throw Error("Unknown type, must be binary type")}};function fo(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}var nr=rr({name:"sha2-256",code:18,encode:fo("SHA-256")}),or=rr({name:"sha2-512",code:19,encode:fo("SHA-512")});function lo(r,e){let{bytes:t,version:n}=r;switch(n){case 0:return Ns(t,sr(r),e??W.encoder);default:return Us(t,sr(r),e??Ee.encoder)}}var ho=new WeakMap;function sr(r){let e=ho.get(r);if(e==null){let t=new Map;return ho.set(r,t),t}return e}var S=class r{code;version;multihash;bytes;"/";constructor(e,t,n,o){this.code=t,this.version=e,this.multihash=n,this.bytes=o,this["/"]=o}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==ze)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Ds)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=ae(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n!=null&&e.code===n.code&&e.version===n.version&&so(e.multihash,n.multihash)}toString(e){return lo(this,e)}toJSON(){return{"/":lo(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:o,multihash:i,bytes:s}=t;return new r(n,o,i,s??po(n,o,i.bytes))}else if(t[Ps]===!0){let{version:n,multihash:o,code:i}=t,s=io(o);return r.create(n,i,s)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ze)throw new Error(`Version 0 CID must use dag-pb (code: ${ze}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let o=po(e,t,n.bytes);return new r(e,t,n,o)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,ze,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,o=J(e.subarray(n,n+t.multihashSize));if(o.byteLength!==t.multihashSize)throw new Error("Incorrect length");let i=o.subarray(t.multihashSize-t.digestSize),s=new Ae(t.multihashCode,t.digestSize,i,o);return[t.version===0?r.createV0(s):r.createV1(t.codec,s),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[m,k]=Oe(e.subarray(t));return t+=k,m},o=n(),i=ze;if(o===18?(o=0,t=0):i=n(),o!==0&&o!==1)throw new RangeError(`Invalid CID version ${o}`);let s=t,c=n(),u=n(),p=t+u,h=p-s;return{version:o,codec:i,multihashCode:c,digestSize:u,multihashSize:h,size:p}}static parse(e,t){let[n,o]=Cs(e,t),i=r.decode(o);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return sr(i).set(n,e),i}};function Cs(r,e){switch(r[0]){case"Q":{let t=e??W;return[W.prefix,t.decode(`${W.prefix}${r}`)]}case W.prefix:{let t=e??W;return[W.prefix,t.decode(r)]}case Ee.prefix:{let t=e??Ee;return[Ee.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function Ns(r,e,t){let{prefix:n}=t;if(n!==W.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let o=e.get(n);if(o==null){let i=t.encode(r).slice(1);return e.set(n,i),i}else return o}function Us(r,e,t){let{prefix:n}=t,o=e.get(n);if(o==null){let i=t.encode(r);return e.set(n,i),i}else return o}var ze=112,Ds=18;function po(r,e,t){let n=ve(r),o=n+ve(e),i=new Uint8Array(o+t.byteLength);return ke(r,i,0),ke(e,i,n),i.set(t,o),i}var Ps=Symbol.for("@ipld/js-cid/CID");var ar={...Xt,...jt,...Qt,...qt,...Vt,...Ht,...Gt,...Kt,...Jt,...Wt},cf={...ir,...er};function mo(r=0){return globalThis.Buffer?.allocUnsafe!=null?dt(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function go(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var yo=go("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),cr=go("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=mo(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),Rs={utf8:yo,"utf-8":yo,hex:ar.base16,latin1:cr,ascii:cr,binary:cr,...ar},mt=Rs;function yt(r,e="utf8"){let t=mt[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?dt(globalThis.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}function gt(r,e="utf8"){let t=mt[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):t.encoder.encode(r).substring(1)}var Q="/",wo=new TextEncoder().encode(Q),wt=wo[0],X=class r{_buf;constructor(e,t){if(typeof e=="string")this._buf=yt(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==wt)throw new Error("Invalid key")}toString(e="utf8"){return gt(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new r(e.join(Q))}static random(){return new r(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new r(e):typeof e.uint8Array=="function"?new r(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=wo),this._buf[0]!==wt){let e=new Uint8Array(this._buf.byteLength+1);e.fill(wt,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===wt;)this._buf=this._buf.subarray(0,-1)}less(e){let t=this.list(),n=e.list();for(let o=0;o<t.length;o++){if(n.length<o+1)return!1;let i=t[o],s=n[o];if(i<s)return!0;if(i>s)return!1}return t.length<n.length}reverse(){return r.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Q).slice(1)}type(){return $s(this.baseNamespace())}name(){return Os(this.baseNamespace())}instance(e){return new r(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(Q)||(e+=Q),e+=this.type(),new r(e)}parent(){let e=this.list();return e.length===1?new r(Q):new r(e.slice(0,-1).join(Q))}child(e){return this.toString()===Q?e:e.toString()===Q?this:new r(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return r.withNamespaces([...this.namespaces(),...Ms(e.map(t=>t.namespaces()))])}};function $s(r){let e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function Os(r){let e=r.split(":");return e[e.length-1]}function Ms(r){return[].concat(...r)}function Fe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}var zs=42;function Fs(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return S.decode(r.subarray(1))}var qs={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};qs.tags[zs]=Fs;var xo=113;var bo=class extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){let t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===a.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===a.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[a.uint.major](e,t){this.prefix(e);let n=String(t.value),o=[];for(let i=0;i<n.length;i++)o[i]=n.charCodeAt(i);e.push(o)}[a.negint.major](e,t){this[a.uint.major](e,t)}[a.bytes.major](e,t){throw new Error(`${ye} unsupported type: Uint8Array`)}[a.string.major](e,t){this.prefix(e);let n=tt(JSON.stringify(t.value));e.push(n.length>32?Ie(n):n)}[a.array.major](e,t){this.prefix(e),this.inRecursive.push({type:a.array,elements:0}),e.push([91])}[a.map.major](e,t){this.prefix(e),this.inRecursive.push({type:a.map,elements:0}),e.push([123])}[a.tag.major](e,t){}[a.float.major](e,t){if(t.type.name==="break"){let s=this.inRecursive.pop();if(s){if(s.type===a.array)e.push([93]);else if(s.type===a.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${ye} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}let n=String(t.value),o=[],i=!1;for(let s=0;s<n.length;s++)o[s]=n.charCodeAt(s),!i&&(o[s]===46||o[s]===101||o[s]===69)&&(i=!0);i||(o.push(46),o.push(48)),e.push(o)}};var ce=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${d} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${d} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){let e=this._pos,t=!1,n=!1,o=c=>{for(;!this.done();){let u=this.ch();if(c.includes(u))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,n=!0;else return new f(a.uint,0,this._pos-e);if(o([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${d} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${d} unexpected token at position ${this._pos}`);n=!0,this._pos++,o([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,o([48,49,50,51,52,53,54,55,56,57]));let i=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),s=parseFloat(i);return n?new f(a.float,s,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(s)?new f(s>=0?a.uint:a.negint,s,this._pos-e):new f(s>=0?a.uint:a.negint,BigInt(i),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${d} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let i=this._pos,s=0;i<this.data.length&&s<65536;i++,s++){let c=this.data[i];if(c===92||c<32||c>=128)break;if(c===34){let u=String.fromCharCode.apply(null,this.data.subarray(this._pos,i));return this._pos=i+1,new f(a.string,u,s)}}let e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${d} unexpected end of unicode escape sequence at position ${this._pos}`);let i=0;for(let s=0;s<4;s++){let c=this.ch();if(c>=48&&c<=57)c-=48;else if(c>=97&&c<=102)c=c-97+10;else if(c>=65&&c<=70)c=c-65+10;else throw new Error(`${d} unexpected unicode escape character at position ${this._pos}`);i=i*16+c,this._pos++}return i},o=()=>{let i=this.ch(),s=null,c=i>239?4:i>223?3:i>191?2:1;if(this._pos+c>this.data.length)throw new Error(`${d} unexpected unicode sequence at position ${this._pos}`);let u,p,h,m;switch(c){case 1:i<128&&(s=i);break;case 2:u=this.data[this._pos+1],(u&192)===128&&(m=(i&31)<<6|u&63,m>127&&(s=m));break;case 3:u=this.data[this._pos+1],p=this.data[this._pos+2],(u&192)===128&&(p&192)===128&&(m=(i&15)<<12|(u&63)<<6|p&63,m>2047&&(m<55296||m>57343)&&(s=m));break;case 4:u=this.data[this._pos+1],p=this.data[this._pos+2],h=this.data[this._pos+3],(u&192)===128&&(p&192)===128&&(h&192)===128&&(m=(i&15)<<18|(u&63)<<12|(p&63)<<6|h&63,m>65535&&m<1114112&&(s=m))}s===null?(s=65533,c=1):s>65535&&(s-=65536,t.push(s>>>10&1023|55296),s=56320|s&1023),t.push(s),this._pos+=c};for(;!this.done();){let i=this.ch(),s;switch(i){case 92:if(this._pos++,this.done())throw new Error(`${d} unexpected string termination at position ${this._pos}`);switch(s=this.ch(),this._pos++,s){case 34:case 39:case 92:case 47:t.push(s);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${d} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new f(a.string,Lt(t),this._pos-e);default:if(i<32)throw new Error(`${d} invalid control character at position ${this._pos}`);i<128?(t.push(i),this._pos++):o()}}throw new Error(`${d} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new f(a.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new f(a.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new f(a.null,null,4);case 102:return this.expect([102,97,108,115,101]),new f(a.false,!1,5);case 116:return this.expect([116,114,117,101]),new f(a.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${d} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new f(a.break,void 0,1);if(this.ch()!==44)throw new Error(`${d} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new f(a.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new f(a.break,void 0,1);if(this.ch()!==44)throw new Error(`${d} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new f(a.break,void 0,1);let e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${d} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${d} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}};function xt(r,e){return e=Object.assign({tokenizer:new ce(r,e)},e),j(r,e)}var Ws={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};Ws.tags[42]=S.parse;var ko=297;var Vf=new TextDecoder;var jf=new TextEncoder;var Gs=new TextDecoder;function ur(r,e){let t=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(e>=r.length)throw new Error("protobuf: unexpected end of data");let o=r[e++];if(t+=n<28?(o&127)<<n:(o&127)*2**n,o<128)break}return[t,e]}function bt(r,e){let t;[t,e]=ur(r,e);let n=e+t;if(t<0||n<0)throw new Error("protobuf: invalid length");if(n>r.length)throw new Error("protobuf: unexpected end of data");return[r.subarray(e,n),n]}function vo(r,e){let t;return[t,e]=ur(r,e),[t&7,t>>3,e]}function Ks(r){let e={},t=r.length,n=0;for(;n<t;){let o,i;if([o,i,n]=vo(r,n),i===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(o!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${o}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,n]=bt(r,n)}else if(i===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(o!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${o}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let s;[s,n]=bt(r,n),e.Name=Gs.decode(s)}else if(i===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(o!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${o}) for Tsize`);[e.Tsize,n]=ur(r,n)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${i}`)}if(n>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function Ao(r){let e=r.length,t=0,n,o=!1,i;for(;t<e;){let c,u;if([c,u,t]=vo(r,t),c!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${c}`);if(u===1){if(i)throw new Error("protobuf: (PBNode) duplicate Data section");[i,t]=bt(r,t),n&&(o=!0)}else if(u===2){if(o)throw new Error("protobuf: (PBNode) duplicate Links section");n||(n=[]);let p;[p,t]=bt(r,t),n.push(Ks(p))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${u}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");let s={};return i&&(s.Data=i),s.Links=n||[],s}var Hf=new TextEncoder,Gf=2**32,Kf=2**31;var Xf=new TextEncoder;var To=112;function _o(r){let e=Ao(r),t={};return e.Data&&(t.Data=e.Data),e.Links&&(t.Links=e.Links.map(n=>{let o={};try{o.Hash=S.decode(n.Hash)}catch{}if(!o.Hash)throw new Error("Invalid Hash field found in link, expected CID");return n.Name!==void 0&&(o.Name=n.Name),n.Tsize!==void 0&&(o.Tsize=n.Tsize),o})),t}var lr={codec:To,*walk(r){yield*_o(r).Links.map(t=>t.Hash)}},dr={codec:eo,*walk(){}},So=42,hr={codec:xo,*walk(r){let e=[],t=[];t[So]=n=>{if(n[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");let o=S.decode(n.subarray(1));return e.push(o),o},j(r,{tags:t}),yield*e}},fr=class extends ce{tokenBuffer;constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){let e=this._next();if(e.type===a.map){let t=this._next();if(t.type===a.string&&t.value==="/"){let n=this._next();if(n.type===a.string){if(this._next().type!==a.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new f(a.tag,42,0)}if(n.type===a.map){let o=this._next();if(o.type===a.string&&o.value==="bytes"){let i=this._next();if(i.type===a.string){for(let c=0;c<2;c++)if(this._next().type!==a.break)throw new Error("Invalid encoded Bytes form");let s=ht.decode(`m${i.value}`);return new f(a.bytes,s,i.value.length)}this.tokenBuffer.push(i)}this.tokenBuffer.push(o)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}},pr={codec:ko,*walk(r){let e=[],t=[];t[So]=n=>{let o=S.parse(n);return e.push(o),o},xt(r,{tags:t,tokenizer:new fr(r,{tags:t,allowIndefinite:!0,allowUndefined:!0,allowNaN:!0,allowInfinity:!0,allowBigInt:!0,strict:!1,rejectDuplicateMapKeys:!1})}),yield*e}},Io={codec:Yn,*walk(){}};function Lo(r=[]){return[lr,dr,hr,pr,...r]}var Qs=[dr,lr,hr,pr,Io],Uo="/pin/",Bo="/pinned-block/",mr=Re,Co=1;function No(r){return r.version===0&&(r=r.toV1()),new X(`${Uo}${r.toString(mr)}`)}var Et=class{datastore;blockstore;dagWalkers;constructor(e,t,n){this.datastore=e,this.blockstore=t,this.dagWalkers={},[...Qs,...n].forEach(o=>{this.dagWalkers[o.codec]=o})}async*add(e,t={}){let n=No(e);if(await this.datastore.has(n))throw new Error("Already pinned");let o=Math.round(t.depth??1/0);if(o<0)throw new Error("Depth must be greater than or equal to 0");let i=new Se({concurrency:Co});for await(let c of this.#e(e,i,{...t,depth:o}))await this.#o(c,u=>u.pinnedBy.find(p=>Fe(p,e.bytes))!=null?!1:(u.pinCount++,u.pinnedBy.push(e.bytes),!0),t),yield c;let s={depth:o,metadata:t.metadata??{}};await this.datastore.put(n,Ue(s),t)}async*#e(e,t,n){if(n.depth===-1)return;let o=this.dagWalkers[e.code];if(o==null)throw new Error(`No dag walker found for cid codec ${e.code}`);let i=await this.blockstore.get(e,n);yield e;for await(let s of o.walk(i))yield*await t.add(async()=>this.#e(s,t,{...n,depth:n.depth-1}))}async#o(e,t,n){let o=new X(`${Bo}${mr.encode(e.multihash.bytes)}`),i={pinCount:0,pinnedBy:[]};try{i=j(await this.datastore.get(o,n))}catch(c){if(c.code!=="ERR_NOT_FOUND")throw c}if(t(i)){if(i.pinCount===0&&await this.datastore.has(o)){await this.datastore.delete(o);return}await this.datastore.put(o,Ue(i),n),n.onProgress?.(new x("helia:pin:add",e))}}async*rm(e,t={}){let n=No(e),o=await this.datastore.get(n,t),i=j(o);await this.datastore.delete(n,t);let s=new Se({concurrency:Co});for await(let c of this.#e(e,s,{...t,depth:i.depth}))await this.#o(c,u=>(u.pinCount--,u.pinnedBy=u.pinnedBy.filter(p=>Fe(p,e.bytes)),!0),{...t,depth:i.depth}),yield c}async*ls(e={}){for await(let{key:t,value:n}of this.datastore.query({prefix:Uo+(e.cid!=null?`${e.cid.toString(Re)}`:"")},e)){let o=S.parse(t.toString().substring(5),Re),i=j(n);yield{cid:o,...i}}}async isPinned(e,t={}){let n=new X(`${Bo}${mr.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}};var gr=ti(Po(),1);var Ve=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},wr=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},Ro=r=>globalThis.DOMException===void 0?new wr(r):new DOMException(r),$o=r=>{let e=r.reason===void 0?Ro("This operation was aborted."):r.reason;return e instanceof Error?e:Ro(e)};function je(r,e){let{milliseconds:t,fallback:n,message:o,customTimers:i={setTimeout,clearTimeout}}=e,s,u=new Promise((p,h)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:k}=e;k.aborted&&h($o(k)),k.addEventListener("abort",()=>{h($o(k))})}if(t===Number.POSITIVE_INFINITY){r.then(p,h);return}let m=new Ve;s=i.setTimeout.call(void 0,()=>{if(n){try{p(n())}catch(k){h(k)}return}typeof r.cancel=="function"&&r.cancel(),o===!1?p():o instanceof Error?h(o):(m.message=o??`Promise timed out after ${t} milliseconds`,h(m))},t),(async()=>{try{p(await r)}catch(k){h(k)}})()}).finally(()=>{u.clear()});return u.clear=()=>{i.clearTimeout.call(void 0,s),s=void 0},u}function xr(r,e,t){let n=0,o=r.length;for(;o>0;){let i=Math.trunc(o/2),s=n+i;t(r[s],e)<=0?(n=++s,o-=i+1):o=i}return n}var We=class{#e=[];enqueue(e,t){t={priority:0,...t};let n={priority:t.priority,run:e};if(this.size&&this.#e[this.size-1].priority>=t.priority){this.#e.push(n);return}let o=xr(this.#e,n,(i,s)=>s.priority-i.priority);this.#e.splice(o,0,n)}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}};var Te=class extends gr.default{#e;#o;#s=0;#h;#a;#p=0;#r;#c;#t;#m;#n=0;#u;#i;#y;timeout;constructor(e){if(super(),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:We,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#e=e.carryoverConcurrencyCount,this.#o=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#h=e.intervalCap,this.#a=e.interval,this.#t=new e.queueClass,this.#m=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#y=e.throwOnTimeout===!0,this.#i=e.autoStart===!1}get#x(){return this.#o||this.#s<this.#h}get#b(){return this.#n<this.#u}#E(){this.#n--,this.#f(),this.emit("next")}#k(){this.#w(),this.#g(),this.#c=void 0}get#v(){let e=Date.now();if(this.#r===void 0){let t=this.#p-e;if(t<0)this.#s=this.#e?this.#n:0;else return this.#c===void 0&&(this.#c=setTimeout(()=>{this.#k()},t)),!0}return!1}#f(){if(this.#t.size===0)return this.#r&&clearInterval(this.#r),this.#r=void 0,this.emit("empty"),this.#n===0&&this.emit("idle"),!1;if(!this.#i){let e=!this.#v;if(this.#x&&this.#b){let t=this.#t.dequeue();return t?(this.emit("active"),t(),e&&this.#g(),!0):!1}}return!1}#g(){this.#o||this.#r!==void 0||(this.#r=setInterval(()=>{this.#w()},this.#a),this.#p=Date.now()+this.#a)}#w(){this.#s===0&&this.#n===0&&this.#r&&(clearInterval(this.#r),this.#r=void 0),this.#s=this.#e?this.#n:0,this.#l()}#l(){for(;this.#f(););}get concurrency(){return this.#u}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#u=e,this.#l()}async#A(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(e.reason)},{once:!0})})}async add(e,t={}){return t={timeout:this.timeout,throwOnTimeout:this.#y,...t},new Promise((n,o)=>{this.#t.enqueue(async()=>{this.#n++,this.#s++;try{t.signal?.throwIfAborted();let i=e({signal:t.signal});t.timeout&&(i=je(Promise.resolve(i),{milliseconds:t.timeout})),t.signal&&(i=Promise.race([i,this.#A(t.signal)]));let s=await i;n(s),this.emit("completed",s)}catch(i){if(i instanceof Ve&&!t.throwOnTimeout){n();return}o(i),this.emit("error",i)}finally{this.#E()}},t),this.emit("add"),this.#f()})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this.#i?(this.#i=!1,this.#l(),this):this}pause(){this.#i=!0}clear(){this.#t=new this.#m}async onEmpty(){this.#t.size!==0&&await this.#d("empty")}async onSizeLessThan(e){this.#t.size<e||await this.#d("next",()=>this.#t.size<e)}async onIdle(){this.#n===0&&this.#t.size===0||await this.#d("idle")}async#d(e,t){return new Promise(n=>{let o=()=>{t&&!t()||(this.off(e,o),n())};this.on(e,o)})}get size(){return this.#t.size}sizeBy(e){return this.#t.filter(e).length}get pending(){return this.#n}get isPaused(){return this.#i}};var ne={},_e=r=>{r.addEventListener("message",e=>{_e.dispatchEvent("message",r,e)}),r.port!=null&&r.port.addEventListener("message",e=>{_e.dispatchEvent("message",r,e)})};_e.addEventListener=(r,e)=>{ne[r]==null&&(ne[r]=[]),ne[r].push(e)};_e.removeEventListener=(r,e)=>{ne[r]!=null&&(ne[r]=ne[r].filter(t=>t===e))};_e.dispatchEvent=function(r,e,t){ne[r]!=null&&ne[r].forEach(n=>n(e,t))};var br=_e;var Er="lock:worker:request-read",kr="lock:worker:release-read",vr="lock:master:grant-read",Ar="lock:worker:request-write",Tr="lock:worker:release-write",_r="lock:master:grant-write";var Oo=(r=21)=>Math.random().toString().substring(2);var Mo=(r,e,t,n,o)=>(i,s)=>{if(s.data.type!==t)return;let c={type:s.data.type,name:s.data.name,identifier:s.data.identifier};r.dispatchEvent(new MessageEvent(e,{data:{name:c.name,handler:async()=>{i.postMessage({type:o,name:c.name,identifier:c.identifier}),await new Promise(u=>{let p=h=>{if(h==null||h.data==null)return;let m={type:h.data.type,name:h.data.name,identifier:h.data.identifier};m.type===n&&m.identifier===c.identifier&&(i.removeEventListener("message",p),u())};i.addEventListener("message",p)})}}}))},zo=(r,e,t,n)=>async()=>{let o=Oo();return globalThis.postMessage({type:e,identifier:o,name:r}),new Promise(i=>{let s=c=>{if(c==null||c.data==null)return;let u={type:c.data.type,identifier:c.data.identifier};u.type===t&&u.identifier===o&&(globalThis.removeEventListener("message",s),i(()=>{globalThis.postMessage({type:n,identifier:o,name:r})}))};globalThis.addEventListener("message",s)})},Zs={singleProcess:!1},Fo=r=>{if(r=Object.assign({},Zs,r),!!globalThis.document||r.singleProcess){let t=new EventTarget;return br.addEventListener("message",Mo(t,"requestReadLock",Er,kr,vr)),br.addEventListener("message",Mo(t,"requestWriteLock",Ar,Tr,_r)),t}return{isWorker:!0,readLock:t=>zo(t,Er,vr,kr),writeLock:t=>zo(t,Ar,_r,Tr)}};var ue={},oe;async function Sr(r,e){let t,n=new Promise(o=>{t=o});return r.add(async()=>je((async()=>{await new Promise(o=>{t(()=>{o()})})})(),{milliseconds:e.timeout})),n}var ea=(r,e)=>{if(oe.isWorker===!0)return{readLock:oe.readLock(r,e),writeLock:oe.writeLock(r,e)};let t=new Te({concurrency:1}),n;return{async readLock(){if(n!=null)return Sr(n,e);n=new Te({concurrency:e.concurrency,autoStart:!1});let o=n,i=Sr(n,e);return t.add(async()=>{o.start(),await o.onIdle().then(()=>{n===o&&(n=null)})}),i},async writeLock(){return n=null,Sr(t,e)}}},ta={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function Ir(r){let e=Object.assign({},ta,r);return oe==null&&(oe=Fo(e),oe.isWorker!==!0&&(oe.addEventListener("requestReadLock",t=>{ue[t.data.name]!=null&&ue[t.data.name].readLock().then(async n=>t.data.handler().finally(()=>{n()}))}),oe.addEventListener("requestWriteLock",async t=>{ue[t.data.name]!=null&&ue[t.data.name].writeLock().then(async n=>t.data.handler().finally(()=>{n()}))}))),ue[e.name]==null&&(ue[e.name]=ea(e.name,e)),ue[e.name]}var vt=class{lock;child;pins;started;constructor(e,t,n={}){this.child=e,this.pins=t,this.lock=Ir({singleProcess:n.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await fe(this.child),this.started=!0}async stop(){await le(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){let o=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{o()}}async*putMany(e,t={}){let n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async get(e,t={}){let n=await this.lock.readLock();try{return await this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){let n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){let n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){let n=await this.lock.writeLock();try{let o=this;yield*this.child.deleteMany(async function*(){for await(let i of e){if(await o.pins.isPinned(i))throw new Error("CID was pinned");yield i}}(),t)}finally{n()}}async has(e,t={}){let n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){let t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}};var Lr=new X("/version"),qo=1;async function Vo(r){if(!await r.has(Lr)){await r.put(Lr,yt(`${qo}`));return}let e=await r.get(Lr),t=gt(e);if(parseInt(t,10)!==qo)throw new Error("Unknown datastore version, a datastore migration may be required")}function jo(r=[]){return[nr,or,Zt,...r]}function Wo(r){let e=new globalThis.AbortController;function t(){e.abort();for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(let i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}let o=e.signal;return o.clear=n,o}function ra(r){let[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:o=>{n.push(o)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}var At=ra;function na(r){return r[Symbol.asyncIterator]!=null}function oa(r,e){if(na(r))return async function*(){for await(let c of r)await e(c)&&(yield c)}();let t=At(r),{value:n,done:o}=t.next();if(o===!0)return function*(){}();let i=e(n);if(typeof i.then=="function")return async function*(){await i&&(yield n);for await(let c of t)await e(c)&&(yield c)}();let s=e;return function*(){i===!0&&(yield n);for(let c of t)s(c)&&(yield c)}()}var Ho=oa;function ia(r){return r[Symbol.asyncIterator]!=null}function Go(r){return r?.then!=null}function sa(r,e){if(ia(r))return async function*(){for await(let c of r){let u=e(c);Go(u)&&await u,yield c}}();let t=At(r),{value:n,done:o}=t.next();if(o===!0)return function*(){}();if(typeof e(n)?.then=="function")return async function*(){yield n;for await(let c of t){let u=e(c);Go(u)&&await u,yield c}}();let s=e;return function*(){yield n;for(let c of t)s(c),yield c}()}var Br=sa;function aa(r){return typeof r.retrieve=="function"}function ca(r){return typeof r.announce=="function"}var Tt=class{child;blockRetrievers;blockAnnouncers;hashers;started;log;constructor(e,t){this.log=e.logger.forComponent("helia:networked-storage"),this.child=e.blockstore,this.blockRetrievers=(t.blockBrokers??[]).filter(aa),this.blockAnnouncers=(t.blockBrokers??[]).filter(ca),this.hashers=t.hashers??[],this.started=!1}isStarted(){return this.started}async start(){await fe(this.child,...new Set([...this.blockRetrievers,...this.blockAnnouncers])),this.started=!0}async stop(){await le(this.child,...new Set([...this.blockRetrievers,...this.blockAnnouncers])),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){return await this.child.has(e)?(n.onProgress?.(new x("blocks:put:duplicate",e)),e):(n.onProgress?.(new x("blocks:put:providers:notify",e)),this.blockAnnouncers.forEach(o=>{o.announce(e,t,n)}),n.onProgress?.(new x("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){let n=Ho(e,async({cid:i})=>{let s=await this.child.has(i);return s&&t.onProgress?.(new x("blocks:put-many:duplicate",i)),!s}),o=Br(n,({cid:i,block:s})=>{t.onProgress?.(new x("blocks:put-many:providers:notify",i)),this.blockAnnouncers.forEach(c=>{c.announce(i,s,t)})});t.onProgress?.(new x("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(o,t)}async get(e,t={}){if(t.offline!==!0&&!await this.child.has(e)){t.onProgress?.(new x("blocks:get:providers:get",e));let n=await Ko(e,this.blockRetrievers,this.hashers,{...t,log:this.log});return t.onProgress?.(new x("blocks:get:blockstore:put",e)),await this.child.put(e,n,t),t.onProgress?.(new x("blocks:get:providers:notify",e)),this.blockAnnouncers.forEach(o=>{o.announce(e,n,t)}),n}return t.onProgress?.(new x("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new x("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(Br(e,async n=>{if(t.offline!==!0&&!await this.child.has(n)){t.onProgress?.(new x("blocks:get-many:providers:get",n));let o=await Ko(n,this.blockRetrievers,this.hashers,{...t,log:this.log});t.onProgress?.(new x("blocks:get-many:blockstore:put",n)),await this.child.put(n,o,t),t.onProgress?.(new x("blocks:get-many:providers:notify",n)),this.blockAnnouncers.forEach(i=>{i.announce(n,o,t)})}}))}async delete(e,t={}){t.onProgress?.(new x("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new x("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(let n of e)yield n}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new x("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}},ua=(r,e)=>{let t=e.find(n=>n.code===r.multihash.code);if(t==null)throw new ie(`No hasher configured for multihash code 0x${r.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`,"ERR_UNKNOWN_HASH_ALG");return async n=>{let o=await t.digest(n);if(!Fe(o.digest,r.multihash.digest))throw new ie("Hash of downloaded block did not match multihash from passed CID","ERR_HASH_MISMATCH")}};async function Ko(r,e,t,n){let o=ua(r,t),i=new AbortController,s=Wo([i.signal,n.signal]);try{return await Promise.any(e.map(async c=>{try{let u=!1,p=await c.retrieve(r,{...n,signal:s,validateFn:async h=>{await o(h),u=!0}});return u||await o(p),p}catch(u){throw n.log.error("could not retrieve verified block for %c",r,u),u}}))}finally{s.clear()}}var Cr=class{libp2p;blockstore;datastore;pins;logger;log;constructor(e){this.logger=e.libp2p.logger,this.log=this.logger.forComponent("helia");let t=jo(e.hashers),n={blockstore:e.blockstore,datastore:e.datastore,libp2p:e.libp2p,hashers:t,logger:e.libp2p.logger},o=e.blockBrokers.map(s=>s(n)),i=new Tt(n,{blockBrokers:o,hashers:t});this.pins=new Et(e.datastore,i,Lo(e.dagWalkers)),this.libp2p=e.libp2p,this.blockstore=new vt(i,this.pins,{holdGcLock:e.holdGcLock}),this.datastore=e.datastore}async start(){await Vo(this.datastore),await fe(this.blockstore),await this.libp2p.start()}async stop(){await this.libp2p.stop(),await le(this.blockstore)}async gc(e={}){let t=await this.blockstore.lock.writeLock();try{let n=this,o=this.blockstore.unwrap();this.log("gc start"),await $r(o.deleteMany(async function*(){for await(let{cid:i}of o.getAll())try{if(await n.pins.isPinned(i,e))continue;yield i,e.onProgress?.(new x("helia:gc:deleted",i))}catch(s){n.log.error("Error during gc",s),e.onProgress?.(new x("helia:gc:error",s))}}()))}finally{t()}this.log("gc finished")}};function fa(r){return r==null?!1:["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every(t=>typeof r[t]=="function")}return ri(la);})();
return HeliaCore}));
